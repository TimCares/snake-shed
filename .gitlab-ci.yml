stages:
  - quality
  - test
  - security
  - release

variables:
  UV_VERSION: "0.7"
  PYTHON_VERSION: "3.13"
  UV_CACHE_DIR: .uv-cache

# ---------------------------------------------------------------------------
# Reusable base jobs
# ---------------------------------------------------------------------------

.uv-base:
  image: ghcr.io/astral-sh/uv:${UV_VERSION}-python${PYTHON_VERSION}-bookworm-slim
  before_script:
    - uv sync --group dev --frozen
  cache:
    key: uv-${CI_COMMIT_REF_SLUG}
    paths:
      - ${UV_CACHE_DIR}
      - .venv/

# ============================= QUALITY =====================================

format:
  extends: .uv-base
  stage: quality
  script:
    - uv run ruff format --check .

lint:
  extends: .uv-base
  stage: quality
  script:
    - uv run ruff check .

type-check:
  extends: .uv-base
  stage: quality
  script:
    - uv run pyright

docstring-coverage:
  extends: .uv-base
  stage: quality
  script:
    - uv run interrogate src/

# ============================= TEST ========================================

test:
  extends: .uv-base
  stage: test
  script:
    - uv run pytest --cov --cov-report=term-missing --cov-report=xml:coverage.xml --junitxml=report.xml
  artifacts:
    when: always
    reports:
      junit: report.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'

# ============================= SECURITY ====================================

pip-audit:
  extends: .uv-base
  stage: security
  script:
    - uv run pip-audit
  allow_failure: true

gitleaks:
  stage: security
  image:
    name: zricethezav/gitleaks:latest
    entrypoint: [""]
  script:
    - gitleaks detect --source . --verbose
  allow_failure: true

trivy:
  stage: security
  image:
    name: aquasec/trivy:latest
    entrypoint: [""]
  script:
    - trivy fs --exit-code 1 --severity HIGH,CRITICAL .
  allow_failure: true

include:
  - template: Security/Secret-Detection.gitlab-ci.yml

secret_detection:
  stage: security

# ============================= RELEASE =====================================

semantic-release:
  extends: .uv-base
  stage: release
  variables:
    GIT_DEPTH: 0
  script:
    # 1. Determine next version (read-only, no credentials needed)
    - |
      NEXT=$(uv run semantic-release version --print-tag 2>/dev/null | tail -1)
      CURRENT=$(uv run semantic-release version --print-last-released-tag 2>/dev/null | tail -1)
      VERSION=${NEXT:-$CURRENT}
      echo "VERSION=$VERSION" >> release.env
      echo "Version: $VERSION"
    # 2. If there is a new release, commit + tag + push
    - |
      if [ -n "$NEXT" ]; then
        git remote set-url origin "${CI_SERVER_PROTOCOL}://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
        uv run semantic-release version
      else
        echo "No release needed"
      fi
  artifacts:
    reports:
      dotenv: release.env
